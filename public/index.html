<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Azure AI Foundry + OpenAI Chat</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 24px 16px;
    }

    h1 {
      font-size: 1.4rem;
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 20px;
    }

    #chat-container {
      width: 100%;
      max-width: 720px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #messages {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      min-height: 400px;
      max-height: 60vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 85%;
    }

    .message.user { align-self: flex-end; }
    .message.assistant { align-self: flex-start; }

    .message .label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #718096;
    }

    .message.user .label { text-align: right; }

    .message .bubble {
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.95rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .message.user .bubble {
      background: #0078d4;
      color: #fff;
      border-bottom-right-radius: 3px;
    }

    .message.assistant .bubble {
      background: #edf2ff;
      color: #1a1a2e;
      border-bottom-left-radius: 3px;
    }

    .message.error .bubble {
      background: #fff5f5;
      color: #c53030;
      border: 1px solid #feb2b2;
    }

    #thinking {
      display: none;
      align-self: flex-start;
      color: #718096;
      font-size: 0.9rem;
      font-style: italic;
      padding: 8px 0;
    }

    #input-row {
      display: flex;
      gap: 8px;
    }

    #user-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.95rem;
      resize: none;
      outline: none;
      font-family: inherit;
      line-height: 1.4;
    }

    #user-input:focus { border-color: #0078d4; }

    #send-btn {
      padding: 10px 20px;
      background: #0078d4;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    #send-btn:hover { background: #006bb8; }
    #send-btn:disabled { background: #a0aec0; cursor: not-allowed; }

    #clear-btn {
      align-self: flex-end;
      background: none;
      border: none;
      color: #718096;
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: underline;
    }

    #clear-btn:hover { color: #4a5568; }
  </style>
</head>
<body>
  <h1>Azure AI Foundry + OpenAI Chat</h1>

  <div id="chat-container">
    <div id="messages">
      <div id="thinking">Assistant is thinking...</div>
    </div>

    <div id="input-row">
      <textarea
        id="user-input"
        rows="2"
        placeholder="Type a message and press Enter or click Send..."
      ></textarea>
      <button id="send-btn">Send</button>
    </div>

    <button id="clear-btn">Clear conversation</button>
  </div>

  <script type="module">
    const messagesEl = document.getElementById("messages");
    const thinkingEl = document.getElementById("thinking");
    const inputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const clearBtn = document.getElementById("clear-btn");

    // Conversation history sent with every request (includes system message)
    const history = [
      {
        role: "system",
        content: "You are a helpful assistant powered by Azure AI Foundry and Azure OpenAI.",
      },
    ];

    function appendMessage(role, content) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${role}`;

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = role === "user" ? "You" : role === "error" ? "Error" : "Assistant";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = content;

      wrapper.appendChild(label);
      wrapper.appendChild(bubble);
      messagesEl.insertBefore(wrapper, thinkingEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return bubble;
    }

    function setLoading(loading) {
      sendBtn.disabled = loading;
      inputEl.disabled = loading;
      thinkingEl.style.display = loading ? "flex" : "none";
      if (loading) messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;

      inputEl.value = "";
      appendMessage("user", text);
      history.push({ role: "user", content: text });
      setLoading(true);

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: history }),
        });

        const data = await res.json();

        if (!res.ok) {
          appendMessage("error", data.error ?? "Unknown error from server");
          history.pop(); // remove the failed user message from history
        } else {
          appendMessage("assistant", data.reply);
          history.push({ role: "assistant", content: data.reply });
        }
      } catch (err) {
        appendMessage("error", `Network error: ${err.message}`);
        history.pop();
      } finally {
        setLoading(false);
        inputEl.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    clearBtn.addEventListener("click", () => {
      // Remove all message elements but keep the thinking indicator
      [...messagesEl.children].forEach((el) => {
        if (el !== thinkingEl) el.remove();
      });
      // Reset history but keep system message
      history.splice(1);
    });
  </script>
</body>
</html>
